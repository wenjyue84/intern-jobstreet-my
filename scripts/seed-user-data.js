
const { Client } = require('pg');

const connectionString = "postgres://postgres.wanxlxbaaqfukbxicpjk:KuxIbMkCRqQEp7ZA@aws-1-us-east-1.pooler.supabase.com:6543/postgres?supa=base-pooler.x";

const client = new Client({
    connectionString,
    ssl: {
        rejectUnauthorized: false
    }
});

const seedUser = 'wenjyue@gmail.com';

const companyData = {
    email: seedUser,
    name: 'Tech Innovators Inc.',
    location: 'Bangsar South, Kuala Lumpur',
    registration_number: '202301001234',
    website: 'https://techinnovators.com.my',
    description: 'Leading the way in AI and machine learning solutions for Southeast Asia. We are a dynamic team of engineers and data scientists passionate about solving real-world problems.',
    industry: 'Technology',
    updated_at: new Date().toISOString()
};

const resumeData = {
    user_email: seedUser,
    full_name: 'Wen Jyue Lew',
    university: 'University of Malaya',
    major: 'Computer Science (Artificial Intelligence)',
    graduation_year: '2024',
    cgpa: '3.85',
    skills: ['React', 'Node.js', 'Python', 'TensorFlow', 'PostgreSQL', 'AWS'],
    experience: 'Interned at Grab (3 months) working on backend services. Built a full-stack e-commerce app as a final year project.',
    portfolio_url: 'https://github.com/wenjyue',
    updated_at: new Date().toISOString()
};

const createResumesTableQuery = `
  CREATE TABLE IF NOT EXISTS resumes (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_email TEXT NOT NULL UNIQUE,
    full_name TEXT,
    university TEXT,
    major TEXT,
    graduation_year TEXT,
    cgpa TEXT,
    skills TEXT[],
    experience TEXT,
    portfolio_url TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
  );
`;

const upsertCompanyQuery = `
  INSERT INTO companies (email, name, location, registration_number, website, description, industry, updated_at)
  VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
  ON CONFLICT (email) DO UPDATE SET
    name = EXCLUDED.name,
    location = EXCLUDED.location,
    registration_number = EXCLUDED.registration_number,
    website = EXCLUDED.website,
    description = EXCLUDED.description,
    industry = EXCLUDED.industry,
    updated_at = EXCLUDED.updated_at;
`;

const upsertResumeQuery = `
  INSERT INTO resumes (user_email, full_name, university, major, graduation_year, cgpa, skills, experience, portfolio_url, updated_at)
  VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
  ON CONFLICT (user_email) DO UPDATE SET
    full_name = EXCLUDED.full_name,
    university = EXCLUDED.university,
    major = EXCLUDED.major,
    graduation_year = EXCLUDED.graduation_year,
    cgpa = EXCLUDED.cgpa,
    skills = EXCLUDED.skills,
    experience = EXCLUDED.experience,
    portfolio_url = EXCLUDED.portfolio_url,
    updated_at = EXCLUDED.updated_at;
`;

async function seedUserData() {
    try {
        await client.connect();
        console.log('Connected to database...');

        console.log('Creating "resumes" table if not exists...');
        await client.query(createResumesTableQuery);
        console.log('Table "resumes" ready.');

        console.log(`Seeding company profile for ${seedUser}...`);
        await client.query(upsertCompanyQuery, [
            companyData.email,
            companyData.name,
            companyData.location,
            companyData.registration_number,
            companyData.website,
            companyData.description,
            companyData.industry,
            companyData.updated_at
        ]);
        console.log('Company profile seeded successfully.');

        console.log(`Seeding intern resume for ${seedUser}...`);
        await client.query(upsertResumeQuery, [
            resumeData.user_email,
            resumeData.full_name,
            resumeData.university,
            resumeData.major,
            resumeData.graduation_year,
            resumeData.cgpa,
            resumeData.skills,
            resumeData.experience,
            resumeData.portfolio_url,
            resumeData.updated_at
        ]);
        console.log('Intern resume seeded successfully.');

    } catch (err) {
        console.error('Error seeding user data:', err);
    } finally {
        await client.end();
    }
}

seedUserData();
